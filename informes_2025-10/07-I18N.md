# ğŸŒ Sistema de InternacionalizaciÃ³n - Tarot2

## 1. VisiÃ³n General

Tarot2 implementa un sistema de internacionalizaciÃ³n (i18n) completo que opera en tres niveles:
- **UI Frontend**: Labels, mensajes y textos estÃ¡ticos
- **Contenido de BD**: Entidades traducibles con fallback
- **API**: ResoluciÃ³n de idioma y marcado de fallback

---

## 2. Arquitectura i18n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Nuxt i18n)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Locales: i18n/locales/en.json, es.json                       â”‚  â”‚
â”‚  â”‚  Composable: useI18n() â†’ $t('key')                            â”‚  â”‚
â”‚  â”‚  Componente: <ULocaleSelect>                                  â”‚  â”‚
â”‚  â”‚  Estrategia: prefix_except_default                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    Query param: ?lang=es
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           BACKEND (API)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  getRequestedLanguage(query)  â†’ 'es' | 'en'                   â”‚  â”‚
â”‚  â”‚  COALESCE(t.name, t_en.name) â†’ Fallback automÃ¡tico            â”‚  â”‚
â”‚  â”‚  markLanguageFallback(item)  â†’ { language_is_fallback: bool } â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BASE DE DATOS                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tabla base: worlds, arcana, base_card, ...                   â”‚  â”‚
â”‚  â”‚  Tabla traducciones: worlds_translations (world_id, lang)     â”‚  â”‚
â”‚  â”‚  Constraint: UNIQUE(entity_id, language_code)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. i18n en Frontend

### 3.1 ConfiguraciÃ³n de Nuxt i18n

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  modules: ['@nuxtjs/i18n'],
  i18n: {
    locales: [
      { code: 'en', name: 'English', file: 'en.json' },
      { code: 'es', name: 'EspaÃ±ol', file: 'es.json' }
    ],
    defaultLocale: 'en',
    lazy: true,
    langDir: 'i18n/locales',
    strategy: 'prefix_except_default',
    detectBrowserLanguage: {
      useCookie: true,
      cookieKey: 'i18n_redirected'
    }
  }
})
```

### 3.2 Estructura de Locales

```
i18n/
â”œâ”€â”€ locales/
â”‚   â”œâ”€â”€ en.json          # ~400 claves
â”‚   â””â”€â”€ es.json          # ~400 claves
â””â”€â”€ key_mapping.json     # Mapeo de claves legacy
```

### 3.3 Ejemplo de Archivo Locale

```json
// i18n/locales/en.json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "create": "Create",
    "search": "Search",
    "filter": "Filter",
    "loading": "Loading...",
    "noResults": "No results found"
  },
  "entities": {
    "world": {
      "singular": "World",
      "plural": "Worlds",
      "create": "Create World",
      "edit": "Edit World"
    },
    "arcana": {
      "singular": "Arcana",
      "plural": "Arcana",
      "create": "Create Arcana",
      "edit": "Edit Arcana"
    }
  },
  "status": {
    "draft": "Draft",
    "review": "In Review",
    "approved": "Approved",
    "published": "Published"
  },
  "messages": {
    "saveSuccess": "Changes saved successfully",
    "deleteConfirm": "Are you sure you want to delete this item?",
    "translationMissing": "Translation not available, showing English"
  }
}
```

### 3.4 Uso en Componentes

```vue
<script setup>
const { t, locale } = useI18n()
</script>

<template>
  <h1>{{ t('entities.world.plural') }}</h1>
  
  <UButton>{{ t('common.create') }}</UButton>
  
  <p v-if="item.language_is_fallback" class="text-amber-500">
    {{ t('messages.translationMissing') }}
  </p>
</template>
```

---

## 4. i18n en Base de Datos

### 4.1 PatrÃ³n de Tablas Traducibles

```sql
-- Tabla base (campos no traducibles)
CREATE TABLE worlds (
  id SERIAL PRIMARY KEY,
  code VARCHAR(50) UNIQUE NOT NULL,
  status card_status DEFAULT 'draft',
  is_active BOOLEAN DEFAULT true,
  image VARCHAR(255),
  metadata JSONB DEFAULT '{}',
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  modified_at TIMESTAMP DEFAULT NOW()
);

-- Tabla de traducciones
CREATE TABLE worlds_translations (
  id SERIAL PRIMARY KEY,
  world_id INTEGER REFERENCES worlds(id) ON DELETE CASCADE,
  language_code VARCHAR(5) NOT NULL,
  name VARCHAR(255) NOT NULL,
  short_text TEXT,
  description TEXT,
  lore TEXT,
  flavor_text TEXT,
  UNIQUE(world_id, language_code)
);
```

### 4.2 Campos Traducibles por Entidad

| Entidad | Campos Traducibles |
|---------|-------------------|
| `world` | name, short_text, description, lore, flavor_text |
| `arcana` | name, short_text, description |
| `facet` | name, short_text, description, effects_summary |
| `skill` | name, short_text, description, effect_text |
| `base_card` | name, short_text, description, flavor_text |
| `world_card` | name, short_text, description, flavor_text |
| `tag` | name, short_text, description |
| `effect_type` | name, template, description |
| `effect_target` | name, description |

---

## 5. i18n en API

### 5.1 ResoluciÃ³n de Idioma

```typescript
// server/utils/i18n.ts
export function getRequestedLanguage(query: Record<string, unknown>): string {
  const lang = query.lang || query.language || query.locale
  
  if (typeof lang === 'string') {
    const normalized = lang.toLowerCase().trim()
    if (['en', 'es'].includes(normalized)) {
      return normalized
    }
  }
  
  return 'en' // Fallback por defecto
}
```

### 5.2 Query con Fallback

```typescript
// PatrÃ³n de query con COALESCE
const query = db
  .selectFrom('worlds as w')
  // Join para idioma solicitado
  .leftJoin('worlds_translations as t', (join) =>
    join
      .onRef('t.world_id', '=', 'w.id')
      .on('t.language_code', '=', requestedLang)
  )
  // Join para fallback EN
  .leftJoin('worlds_translations as t_en', (join) =>
    join
      .onRef('t_en.world_id', '=', 'w.id')
      .on('t_en.language_code', '=', 'en')
  )
  .select([
    'w.id',
    'w.code',
    'w.status',
    // Campos traducibles con fallback
    sql`COALESCE(t.name, t_en.name)`.as('name'),
    sql`COALESCE(t.description, t_en.description)`.as('description'),
    sql`COALESCE(t.language_code, 'en')`.as('language_code_resolved')
  ])
```

### 5.3 Marcado de Fallback

```typescript
// server/utils/response.ts
export function markLanguageFallback<T extends Record<string, unknown>>(
  item: T,
  requestedLang: string
): T & { language_is_fallback: boolean } {
  const resolvedLang = item.language_code_resolved as string
  
  return {
    ...item,
    language_is_fallback: resolvedLang !== requestedLang
  }
}

// Uso en handler
const items = await query.execute()
return createPaginatedResponse(
  items.map(i => markLanguageFallback(i, lang)),
  totalItems,
  page,
  pageSize
)
```

### 5.4 Respuesta API con i18n

```json
// GET /api/world?lang=es
{
  "success": true,
  "data": [
    {
      "id": 1,
      "code": "FANTASY",
      "name": "FantasÃ­a Medieval",
      "description": "Un mundo de espadas y magia...",
      "language_code_resolved": "es",
      "language_is_fallback": false
    },
    {
      "id": 2,
      "code": "SCIFI",
      "name": "Sci-Fi Universe",
      "description": "A futuristic setting...",
      "language_code_resolved": "en",
      "language_is_fallback": true
    }
  ],
  "meta": { ... }
}
```

---

## 6. CRUD Multiidioma

### 6.1 CreaciÃ³n (siempre en EN primero)

```typescript
// POST /api/world
// Siempre crea la traducciÃ³n EN como base
const id = await translatableUpsert({
  table: 'worlds',
  translationsTable: 'worlds_translations',
  baseData: { code, status: 'draft', created_by: userId },
  translationData: { name, description },
  lang: 'en' // Siempre inglÃ©s en creaciÃ³n
})
```

### 6.2 ActualizaciÃ³n por Idioma

```typescript
// PATCH /api/world/1?lang=es
// Crea o actualiza la traducciÃ³n especÃ­fica
await translatableUpsert({
  table: 'worlds',
  translationsTable: 'worlds_translations',
  baseData: { code, status }, // Campos base
  translationData: { name, description }, // Campos traducibles
  lang: requestedLang, // 'es' en este caso
  id: entityId
})
```

### 6.3 Borrado por Idioma

```typescript
// DELETE /api/world/1?lang=es
if (lang === 'en') {
  // Borrar entidad completa + todas las traducciones
  await db.transaction().execute(async (trx) => {
    await trx.deleteFrom('worlds_translations')
      .where('world_id', '=', id)
      .execute()
    
    await trx.deleteFrom('worlds')
      .where('id', '=', id)
      .execute()
  })
} else {
  // Solo borrar traducciÃ³n especÃ­fica
  await db.deleteFrom('worlds_translations')
    .where('world_id', '=', id)
    .where('language_code', '=', lang)
    .execute()
}
```

---

## 7. UI de Traducciones

### 7.1 FormModal con Referencia EN

```vue
<!-- Cuando se edita en idioma != EN, mostrar valores EN como referencia -->
<template>
  <UFormField :label="t('fields.name')">
    <UInput v-model="form.name" />
    
    <!-- Referencia del valor EN -->
    <p v-if="locale !== 'en' && englishItem?.name" class="text-sm text-gray-500 mt-1">
      <span class="font-medium">EN:</span> {{ englishItem.name }}
    </p>
  </UFormField>
</template>

<script setup>
// Cargar versiÃ³n EN para referencia
const { data: englishItem } = await useAsyncData(
  `${entityType}-${entityId}-en`,
  () => useApiFetch(`/api/${entityType}/${entityId}?lang=en`)
)
</script>
```

### 7.2 StatusBadge con Indicador de Fallback

```vue
<template>
  <StatusBadge :status="item.status" />
  
  <UBadge v-if="item.language_is_fallback" color="amber" variant="soft">
    <UIcon name="i-lucide-globe" class="w-3 h-3 mr-1" />
    EN
  </UBadge>
</template>
```

### 7.3 Selector de Idioma en Filtros

```vue
<!-- ManageEntityFilters.vue -->
<USelectMenu
  v-model="filters.lang"
  :options="[
    { value: 'en', label: 'English' },
    { value: 'es', label: 'EspaÃ±ol' }
  ]"
  :placeholder="t('filters.language')"
/>
```

---

## 8. Scripts de Mantenimiento

### 8.1 Ordenar Claves i18n

```javascript
// scripts/sort-i18n.mjs
import { readFileSync, writeFileSync } from 'fs'

const files = ['i18n/locales/en.json', 'i18n/locales/es.json']

for (const file of files) {
  const content = JSON.parse(readFileSync(file, 'utf-8'))
  const sorted = sortObjectDeep(content)
  writeFileSync(file, JSON.stringify(sorted, null, 2) + '\n')
}

function sortObjectDeep(obj) {
  if (typeof obj !== 'object' || obj === null) return obj
  
  return Object.keys(obj)
    .sort()
    .reduce((acc, key) => {
      acc[key] = sortObjectDeep(obj[key])
      return acc
    }, {})
}
```

### 8.2 Detectar Claves Faltantes

```javascript
// scripts/missed-i18n.mjs
import { readFileSync } from 'fs'

const en = JSON.parse(readFileSync('i18n/locales/en.json', 'utf-8'))
const es = JSON.parse(readFileSync('i18n/locales/es.json', 'utf-8'))

const missingInEs = findMissingKeys(en, es)
const missingInEn = findMissingKeys(es, en)

console.log('Missing in ES:', missingInEs)
console.log('Missing in EN:', missingInEn)

function findMissingKeys(source, target, prefix = '') {
  const missing = []
  
  for (const key of Object.keys(source)) {
    const fullKey = prefix ? `${prefix}.${key}` : key
    
    if (!(key in target)) {
      missing.push(fullKey)
    } else if (typeof source[key] === 'object') {
      missing.push(...findMissingKeys(source[key], target[key], fullKey))
    }
  }
  
  return missing
}
```

### 8.3 AÃ±adir Comentarios Iniciales

```javascript
// scripts/add-leading-comments.mjs
// AÃ±ade comentarios de documentaciÃ³n a archivos de presets/composables
```

---

## 9. MÃ©tricas de Cobertura

### 9.1 Cobertura Actual

| Ãrea | EN | ES | Estado |
|------|----|----|--------|
| UI Labels | 100% | 100% | âœ… Completo |
| Mensajes | 100% | 100% | âœ… Completo |
| Errores | 100% | 100% | âœ… Completo |
| Tooltips | 90% | 85% | âš ï¸ En progreso |

### 9.2 Dashboard de Cobertura (Propuesto)

```typescript
// Endpoint: GET /api/i18n/coverage
{
  "success": true,
  "data": {
    "world": { "total": 50, "en": 50, "es": 45, "coverage": { "es": 0.90 } },
    "arcana": { "total": 12, "en": 12, "es": 12, "coverage": { "es": 1.0 } },
    "base_card": { "total": 200, "en": 200, "es": 150, "coverage": { "es": 0.75 } }
  }
}
```

---

## 10. Buenas PrÃ¡cticas

### 10.1 Convenciones de Claves

```json
{
  "entities": {
    "<entityType>": {
      "singular": "...",
      "plural": "...",
      "create": "Create ...",
      "edit": "Edit ..."
    }
  },
  "fields": {
    "<fieldName>": "...",
    "<fieldName>Hint": "..."
  },
  "actions": {
    "<action>": "...",
    "<action>Success": "...",
    "<action>Error": "..."
  }
}
```

### 10.2 Reglas para Traducciones

1. **EN es obligatorio** - Toda entidad debe tener traducciÃ³n EN
2. **Fallback transparente** - Mostrar badge cuando se usa fallback
3. **Referencia visible** - Mostrar texto EN al editar otros idiomas
4. **Borrado seguro** - Confirmar antes de borrar traducciÃ³n EN
5. **SincronizaciÃ³n** - Ejecutar scripts de verificaciÃ³n antes de deploy

### 10.3 Checklist Pre-Deploy

- [ ] Ejecutar `pnpm run i18n:check` (claves faltantes)
- [ ] Ejecutar `pnpm run i18n:sort` (ordenar archivos)
- [ ] Verificar que no hay claves hardcodeadas en componentes
- [ ] Revisar badges de fallback en UI

---

## 11. Roadmap i18n

### 11.1 Corto Plazo

| Tarea | Prioridad | Estado |
|-------|-----------|--------|
| Completar tooltips ES | Media | ğŸ”„ En progreso |
| Dashboard cobertura | Media | ğŸ”„ Pendiente |
| Alertas de fallback | Baja | ğŸ”„ Pendiente |

### 11.2 Medio Plazo

| Tarea | Prioridad | Estado |
|-------|-----------|--------|
| Soporte para mÃ¡s idiomas | Baja | ğŸ“‹ Planificado |
| Auto-sugerencias traducciÃ³n | Baja | ğŸ“‹ Planificado |
| Export/import traducciones | Baja | ğŸ“‹ Planificado |

---

*Este documento detalla el sistema de internacionalizaciÃ³n de Tarot2. Para informaciÃ³n sobre el estado actual, consultar 08-ESTADO-ACTUAL.md.*
