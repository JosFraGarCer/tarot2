# ğŸ“‹ INFORME DE CRÃTICA SENIOR - CÃ“DIGO LEGACY Y DEUDA TÃ‰CNICA

**Fecha:** 2026-01-10  
**Analista:** Senior Dev Reviewer  
**Alcance:** CÃ³digo legacy, deuda tÃ©cnica y problemas de mantenimiento

---

## ğŸš¨ **DEUDA TÃ‰CNICA CATASTRÃ“FICA**

### 1. **CÃ³digo Legacy No Documentado**

**Archivo:** `app/utils/manage/entityRows.ts` (342 lÃ­neas)

**Problema:** Funciones complejas sin documentaciÃ³n ni tests:

```typescript
// âŒ Sin comentarios explicando el propÃ³sito
function pickString(...candidates: Array<unknown>): string | null {
  for (const candidate of candidates) {
    if (typeof candidate === 'string' && candidate.trim().length) {
      return candidate
    }
  }
  return null
}

// âŒ Â¿Por quÃ© estos 20 fallbacks especÃ­ficos?
const name = pickString(
  entity?.name,
  entity?.title,
  entity?.label,
  entity?.code,
  entity?.slug,
  `#${entity?.id ?? 'â€”'}`,
)
```

**Impacto:** Nadie sabe por quÃ© existe esta lÃ³gica, miedo a cambiarla.

### 2. **Comentarios EngaÃ±osos y Obsoletos**

**Archivo:** `app/components/manage/modal/FormModal.vue`

```vue
<!-- app/components/manage/modal/FormModal.vue -->
<!-- app/components/manage/Modal/FormModal.vue -->  <!-- âŒ Path duplicado -->
```

**Archivo:** `server/database/types.ts`
```typescript
/**
 * This file was generated by kysely-codegen.
 * Please do not edit it manually.
 */
// âŒ Pero el archivo SÃ se editÃ³ manualmente
```

### 3. **Imports Circulares y Acoplamiento Oculto**

**MÃºltiples archivos con dependencias cruzadas**

```typescript
// useEntity.ts importa de entityRows.ts
import { mapEntityToRow } from '~/utils/manage/entityRows'

// entityRows.ts usa lÃ³gica que deberÃ­a estar en useEntity
// Creando dependencia circular implÃ­cita
```

---

## âš ï¸ **CÃ“DIGO MUERTO Y NO UTILIZADO**

### 4. **Funciones Muertas por Doquier**

**Archivo:** `app/composables/manage/useEntity.ts`

```typescript
// âŒ FunciÃ³n definida pero nunca usada
function escapeRegExp(value: string): string {
  return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
}

// âŒ Interface exportada pero nunca importada
export interface EntityCrud<TList, TCreate, TUpdate> {
  // 20+ propiedades que nadie usa
}
```

### 5. **Componentes HuÃ©rfanos**

**Directorio:** `app/components/`

```bash
# Componentes que no parecen tener referencias
app/components/deck/          # Â¿Usado?
app/components/card/           # Â¿Usado?
app/components/AppHeader/      # Â¿Obsoleto?
```

### 6. **Schemas No Validados**

**Archivo:** `shared/schemas/entities/`

```typescript
// âŒ Schemas definidos pero no usados en validaciÃ³n
export const arcanaUpdateSchema = z.object({
  code: z.string().min(1).optional(),
  // ... mÃ¡s campos
})

// Pero en el CRUD no se valida
export default arcanaCrud.update  // Sin validaciÃ³n
```

---

## ğŸ” **PROBLEMAS DE MANTENIMIENTO**

### 7. **Nombres Inconsistentes y Confusos**

**Por todo el cÃ³digo base**

```typescript
// âŒ Mismas cosas, nombres diferentes
entity?.modified_at vs entity?.updated_at
entity?.card_type vs entity?.cardType
entity?.arcana vs entity?.Arcana

// âŒ Abreviaciones sin sentido
util vs utils
req vs request
res vs response
```

### 8. **Estructura de Carpetas CaÃ³tica**

```
app/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ manage/           # Â¿Manage o admin?
â”‚   â”œâ”€â”€ admin/           # Â¿Duplica manage?
â”‚   â”œâ”€â”€ common/          # Â¿QuÃ© es comÃºn?
â”‚   â””â”€â”€ deck/            # Â¿Vivo o muerto?
â”œâ”€â”€ composables/
â”‚   â”œâ”€â”€ manage/          # 30+ archivos
â”‚   â”œâ”€â”€ admin/           # 5+ archivos
â”‚   â””â”€â”€ common/          # 10+ archivos
```

### 9. **ConfiguraciÃ³n Fragmentada**

**MÃºltiples archivos de config**

```typescript
// nuxt.config.ts - configuraciÃ³n Nuxt
// eslint.config.mjs - configuraciÃ³n ESLint  
// tsconfig.json - configuraciÃ³n TypeScript
// tailwind.config.ts - configuraciÃ³n Tailwind
// i18n.config.ts - configuraciÃ³n i18n
// .kysely-codegenrc.json - configuraciÃ³n Kysely
// âŒ Sin centralizaciÃ³n, sin documentaciÃ³n
```

---

## ğŸš¨ **CASOS EXTREMOS DE LEGACY**

### 10. **Polglot Code Hell**

**Mezcla de lenguajes y patrones en mismo archivo**

```typescript
// TypeScript con JavaScript
export function useEntity<TList, TCreate, TUpdate>(options) {
  // âŒ ParÃ¡metros sin tipar
  const lang = computed(() => (typeof locale === 'string' ? locale : locale.value) as string)
  
  // SQL en TypeScript
  const query = sql`select coalesce(t_req.name, t_en.name)`
  
  // Template strings con SQL
  const tagsQuery = `select * from tags where name = ${tagName}`
  
  // Regex para parsing
  if (/(^|_)arcana_id$/.test(key)) { ... }
}
```

### 11. **Magic Numbers y Strings**

**Por todo el cÃ³digo base**

```typescript
// âŒ Â¿Por quÃ© 300ms?
debounceTimer = setTimeout(() => { ... }, 300)

// âŒ Â¿Por quÃ© 20?
pageSize: z.coerce.number().int().min(1).max(100).default(20)

// âŒ Â¿Por quÃ© estos strings especÃ­ficos?
if (entity?.entity_type === 'arcana') { ... }
if (status === 'draft') { ... }
```

### 12. **Try-Catch Hell**

**Archivo:** `app/components/manage/modal/FormModal.vue`

```typescript
// âŒ Silenciar errores - peor prÃ¡ctica
try {
  // 50 lÃ­neas de lÃ³gica compleja
  const fields = buildFieldsFromSchema()
  return fields
} catch {
  // âŒ Error swallowed - imposible debuggear
  return {}
}
```

---

## ğŸ“Š **ANÃLISIS DE DEUDA TÃ‰CNICA**

### Por CategorÃ­a

| CategorÃ­a | Archivos Afectados | Complejidad | Impacto |
|-----------|-------------------|-------------|---------|
| **Sin Documentar** | 80% | ğŸš¨ Extrema | CrÃ­tico |
| **CÃ³digo Muerto** | 40% | âš ï¸ Media | Alto |
| **Nombres Confusos** | 60% | âš ï¸ Alta | Medio |
| **Estructura CaÃ³tica** | 100% | ğŸš¨ Extrema | CrÃ­tico |
| **Config Fragmentada** | 6 archivos | âš ï¸ Media | Medio |

### Por Archivo CrÃ­tico

| Archivo | LÃ­neas | Deuda TÃ©cnica | Mantenibilidad |
|---------|--------|---------------|----------------|
| **useEntity.ts** | 659 | ğŸš¨ CatastrÃ³fica | âŒ Imposible |
| **entityRows.ts** | 342 | ğŸš¨ Extrema | âŒ Muy difÃ­cil |
| **FormModal.vue** | 410 | ğŸš¨ Extrema | âŒ Muy difÃ­cil |
| **_crud.ts** | 185 | âš ï¸ Alta | âš ï¸ DifÃ­cil |
| **createCrudHandlers.ts** | 200+ | âš ï¸ Alta | âš ï¸ DifÃ­cil |

---

## ğŸ¯ **RECOMENDACIONES DE LIMPIEZA**

### Fase 1: DocumentaciÃ³n Emergente (1 semana)
1. **AÃ±adir JSDoc** a funciones crÃ­ticas
2. **Documentar decisiones** en comentarios
3. **Mapear dependencias** entre archivos
4. **Identificar cÃ³digo muerto** con herramientas

### Fase 2: Limpieza de Legacy (2-3 semanas)
1. **Eliminar cÃ³digo muerto** confirmado
2. **Renombrar consistentemente** (snake_case â†’ camelCase)
3. **Consolidar configuraciÃ³n** en un solo lugar
4. **Remover imports no usados**

### Fase 3: ReestructuraciÃ³n (3-4 semanas)
1. **Reorganizar carpetas** con criterio claro
2. **Extraer constantes** a archivos dedicados
3. **Estandarizar nombres** de archivos y funciones
4. **Crear guÃ­a de estilo** para equipo

### Fase 4: ModernizaciÃ³n (4-6 semanas)
1. **Reemplazar magic strings** con enums/constants
2. **Implementar proper logging** en lugar de console.log
3. **AÃ±adir type guards** para validaciÃ³n runtime
4. **Migrar a patterns modernos**

---

## ğŸ’€ **VEREDICTO DE LEGACY**

**CalificaciÃ³n:** F- (Basurero tÃ©cnico)

**Problemas crÃ­ticos:**
- 80% del cÃ³digo sin documentar
- 40% de cÃ³digo muerto
- Nombres inconsistentes
- Estructura caÃ³tica
- Decisiones no documentadas

**Impacto en equipo:**
- Nuevo desarrollador: 3-6 meses para ser productivo
- Cambio simple: 10x mÃ¡s tiempo del necesario
- Bug fixes: 80% del tiempo vs features
- Knowledge silos: solo 1-2 personas entienden Ã¡reas

**RecomendaciÃ³n:** **Rewrite estratÃ©gico** de Ã¡reas crÃ­ticas antes de continuar con features.

---

## ğŸš¨ **ADVERTENCIA DE MANTENIMIENTO**

Este cÃ³digo base tiene **deuda tÃ©cnica tÃ©cnica acumulada** que hace el mantenimiento extremadamente costoso y arriesgado.

**Cada nuevo feature:**
- +50% mÃ¡s tiempo de desarrollo
- +80% riesgo de bugs regresivos
- +200% dificultad de testing
- +300% conocimiento requerido

**La deuda tÃ©cnica estÃ¡ pagando intereses diarios** en forma de desarrollo lento, bugs frecuentes y equipo frustrado.
